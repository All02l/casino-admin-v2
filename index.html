<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { color: white; background: #1c1c1c; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 15px; margin: 0; }
        
        /* –¢–∞–±—ã —Å–≤–µ—Ä—Ö—É */
        .tabs { display: flex; gap: 8px; margin-bottom: 15px; background: #2c2c2c; padding: 5px; border-radius: 12px; }
        .tab { flex: 1; padding: 10px; text-align: center; border-radius: 10px; cursor: pointer; font-size: 14px; transition: 0.3s; color: #aaa; }
        .tab.active { background: #0088cc; color: white; font-weight: bold; }
        
        .card { background: #2c2c2c; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #3d3d3d; }
        h3 { margin-top: 0; color: #0088cc; font-size: 16px; margin-bottom: 12px; border-bottom: 1px solid #3d3d3d; padding-bottom: 8px; }
        
        .list-container { max-height: 65vh; overflow-y: auto; }

        /* –≠–ª–µ–º–µ–Ω—Ç —Å–µ—Ä–≤–µ—Ä–∞ */
        .server-item { background: #1a1a1a; padding: 12px; margin-bottom: 10px; border-radius: 10px; border-left: 4px solid #0088cc; font-size: 13px; line-height: 1.6; }
        .server-item b { color: #0088cc; }

        /* –≠–ª–µ–º–µ–Ω—Ç —á–∞—Ç–∞ (–∫–∞–∫ –Ω–∞ —Å–∫—Ä–∏–Ω–µ) */
        .chat-item { background: #262626; padding: 12px; margin-bottom: 8px; border-radius: 10px; display: flex; flex-direction: column; position: relative; border-bottom: 1px solid #333; cursor: pointer; }
        .chat-item:active { background: #333; }
        .chat-item .user { font-weight: bold; color: #0088cc; font-size: 14px; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .chat-item .msg { color: #b3b3b3; font-size: 13px; width: 85%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-item .time { font-size: 11px; color: #666; position: absolute; top: 12px; right: 12px; }

        .empty { color: #666; text-align: center; padding: 20px; font-style: italic; }
        button { background: #0088cc; color: white; border: none; padding: 16px; width: 100%; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.2s; }
        button:active { transform: scale(0.98); opacity: 0.9; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="tabs">
        <div id="tab-btn-servers" class="tab active" onclick="switchTab('servers')">üñ• –°–µ—Ä–≤–µ—Ä–∞</div>
        <div id="tab-btn-chats" class="tab" onclick="switchTab('chats')">üí¨ –î–∏–∞–ª–æ–≥–∏</div>
    </div>

    <div id="view-servers">
        <div class="card">
            <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</h3>
            <div id="server-list" class="list-container">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>
        <button onclick="addServer()">‚ûï –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</button>
    </div>

    <div id="view-chats" class="hidden">
        <div class="card">
            <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è</h3>
            <div id="chat-list" class="list-container">
                <div class="empty">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>
            </div>
        </div>
        <p style="font-size: 11px; color: #555; text-align: center;">–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —á–∞—Ç, —á—Ç–æ–±—ã –ø–µ—Ä–µ–π—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å –∏–≥—Ä–æ–∫–∞</p>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        const urlParams = new URLSearchParams(window.location.search);

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(target) {
            const isServers = target === 'servers';
            document.getElementById('view-servers').classList.toggle('hidden', !isServers);
            document.getElementById('view-chats').classList.toggle('hidden', isServers);
            
            document.getElementById('tab-btn-servers').classList.toggle('active', isServers);
            document.getElementById('tab-btn-chats').classList.toggle('active', !isServers);
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –°–µ—Ä–≤–µ—Ä–æ–≤
        function renderServers() {
            const rawData = urlParams.get('data');
            const container = document.getElementById('server-list');
            
            if (rawData && rawData !== "none" && rawData.trim() !== "") {
                const servers = rawData.split("|");
                container.innerHTML = servers.map(s => {
                    const p = s.split(":");
                    if (p.length === 3) {
                        return `<div class="server-item">
                            üÜî –°–µ—Ä–≤–µ—Ä: <b>${p[0]}</b><br>
                            üí≥ –°—á–µ—Ç: <code>${p[1]}</code><br>
                            üë§ –ù–∏–∫: ${p[2]}
                        </div>`;
                    }
                    return "";
                }).join("");
            } else {
                container.innerHTML = '<div class="empty">–°–µ—Ä–≤–µ—Ä–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã</div>';
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ß–∞—Ç–æ–≤ (–î–∏–∞–ª–æ–≥–æ–≤)
        function renderChats() {
            const chatsData = urlParams.get('chats');
            const container = document.getElementById('chat-list');
            
            if (chatsData && chatsData !== "none" && chatsData.trim() !== "") {
                const chats = chatsData.split("|");
                container.innerHTML = chats.map(c => {
                    const p = c.split(":");
                    // –û–∂–∏–¥–∞–µ–º id:name:text:time (4 —ç–ª–µ–º–µ–Ω—Ç–∞)
                    if (p.length === 4) {
                        const [id, name, msg, time] = p;
                        return `
                            <div class="chat-item" onclick="window.location.href='tg://user?id=${id}'">
                                <div class="user">${name}</div>
                                <div class="msg">${msg}</div>
                                <div class="time">${time}</div>
                            </div>`;
                    }
                    return "";
                }).join("");
            } else {
                container.innerHTML = '<div class="empty">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤</div>';
            }
        }

        // –ó–∞–ø—É—Å–∫ —Ä–µ–Ω–¥–µ—Ä–∞
        renderServers();
        renderChats();

        // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞
        function addServer() {
            let id = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 4):");
            if (!id) return;
            let acc = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ —Å—á–µ—Ç–∞:");
            if (!acc) return;
            let name = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—è:");
            if (!name) return;

            tg.sendData(`set_server:${id}|${acc}|${name}`);
            tg.close();
        }
    </script>
</body>
</html>
