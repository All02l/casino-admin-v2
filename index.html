<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { color: white; background: #1c1c1c; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 15px; margin: 0; }
        
        .tabs { display: flex; gap: 8px; margin-bottom: 15px; background: #2c2c2c; padding: 5px; border-radius: 12px; }
        .tab { flex: 1; padding: 10px; text-align: center; border-radius: 10px; cursor: pointer; font-size: 14px; transition: 0.3s; color: #aaa; }
        .tab.active { background: #0088cc; color: white; font-weight: bold; }
        
        .card { background: #2c2c2c; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #3d3d3d; }
        h3 { margin-top: 0; color: #0088cc; font-size: 16px; margin-bottom: 12px; border-bottom: 1px solid #3d3d3d; padding-bottom: 8px; }
        
        .list-container { max-height: 65vh; overflow-y: auto; }

        /* –≠–ª–µ–º–µ–Ω—Ç —Å–µ—Ä–≤–µ—Ä–∞ */
        .server-item { background: #1a1a1a; padding: 12px; margin-bottom: 10px; border-radius: 10px; border-left: 4px solid #0088cc; font-size: 13px; }

        /* –≠–ª–µ–º–µ–Ω—Ç –ó–ê–Ø–í–ö–ò (–û—Ä–∞–Ω–∂–µ–≤–∞—è –ø–æ–ª–æ—Å–∞ - –≤–Ω–∏–º–∞–Ω–∏–µ) */
        .order-item { background: #262626; padding: 12px; margin-bottom: 10px; border-radius: 10px; border-left: 4px solid #f39c12; position: relative; }
        .order-item .header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        .order-item .details { color: #bbb; font-size: 13px; line-height: 1.4; }
        .order-item b { color: #f39c12; }

        .empty { color: #666; text-align: center; padding: 20px; font-style: italic; }
        button { background: #0088cc; color: white; border: none; padding: 16px; width: 100%; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="tabs">
        <div id="tab-btn-servers" class="tab active" onclick="switchTab('servers')">üñ• –°–µ—Ä–≤–µ—Ä–∞</div>
        <div id="tab-btn-orders" class="tab" onclick="switchTab('orders')">üí∞ –ó–∞—è–≤–∫–∏</div>
    </div>

    <div id="view-servers">
        <div class="card">
            <h3>–†–µ–∫–≤–∏–∑–∏—Ç—ã —Å–µ—Ä–≤–µ—Ä–æ–≤</h3>
            <div id="server-list" class="list-container">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        <button onclick="addServer()">‚ûï –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</button>
    </div>

    <div id="view-orders" class="hidden">
        <div class="card">
            <h3>–û–∂–∏–¥–∞—é—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</h3>
            <div id="order-list" class="list-container">
                <div class="empty">–ó–∞—è–≤–æ–∫ –Ω–µ—Ç</div>
            </div>
        </div>
        <p style="font-size: 11px; color: #555; text-align: center;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ–ø–ª–∞—Ç—É –≤ —á–∞—Ç–µ –±–æ—Ç–∞ —Å –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–æ–∫ –ø–æ–¥ —Ñ–æ—Ç–æ</p>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        const urlParams = new URLSearchParams(window.location.search);

        function switchTab(target) {
            const isServers = target === 'servers';
            document.getElementById('view-servers').classList.toggle('hidden', !isServers);
            document.getElementById('view-orders').classList.toggle('hidden', isServers);
            document.getElementById('tab-btn-servers').classList.toggle('active', isServers);
            document.getElementById('tab-btn-orders').classList.toggle('active', !isServers);
        }

        // –†–µ–Ω–¥–µ—Ä —Å–µ—Ä–≤–µ—Ä–æ–≤ (—Å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
        function renderServers() {
            let rawData = urlParams.get('data');
            if (!rawData) return;
            rawData = decodeURIComponent(rawData); // –î–µ–∫–æ–¥–∏—Ä—É–µ–º –∏–∑ Python quote
            
            const container = document.getElementById('server-list');
            if (rawData !== "none") {
                container.innerHTML = rawData.split("|").map(s => {
                    const p = s.split(":");
                    return `<div class="server-item">üÜî –°–µ—Ä–≤–µ—Ä: <b>${p[0]}</b><br>üí≥ –°—á–µ—Ç: ${p[1]}<br>üë§ –ù–∏–∫: ${p[2]}</div>`;
                }).join("");
            }
        }

        // –†–µ–Ω–¥–µ—Ä –ó–ê–Ø–í–û–ö (—Å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
        function renderOrders() {
            let ordersData = urlParams.get('chats'); // –ü–∞—Ä–∞–º–µ—Ç—Ä chats —Ç–µ–ø–µ—Ä—å —Ö—Ä–∞–Ω–∏—Ç –∑–∞—è–≤–∫–∏
            if (!ordersData) return;
            ordersData = decodeURIComponent(ordersData); 

            const container = document.getElementById('order-list');
            if (ordersData !== "none" && ordersData !== "too_long") {
                container.innerHTML = ordersData.split("|").map(o => {
                    const p = o.split(":"); // dep_id:name:amount:server
                    if (p.length === 4) {
                        return `
                            <div class="order-item">
                                <div class="header">
                                    <span>–ó–∞—è–≤–∫–∞ #${p[0]}</span>
                                    <span>${p[2]} –º–æ–Ω–µ—Ç</span>
                                </div>
                                <div class="details">
                                    –ò–≥—Ä–æ–∫: <b>@${p[1]}</b><br>
                                    –°–µ—Ä–≤–µ—Ä: <b>${p[3]}</b>
                                </div>
                            </div>`;
                    }
                    return "";
                }).join("");
            } else {
                container.innerHTML = '<div class="empty">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫ –Ω–µ—Ç</div>';
            }
        }

        renderServers();
        renderOrders();

        function addServer() {
            let id = prompt("–ù–æ–º–µ—Ä —Å–µ—Ä–≤–µ—Ä–∞:");
            let acc = prompt("–ù–æ–º–µ—Ä —Å—á–µ—Ç–∞:");
            let name = prompt("–ù–∏–∫:");
            if (id && acc && name) {
                tg.sendData(`set_server:${id}|${acc}|${name}`);
                tg.close();
            }
        }
    </script>
</body>
</html>
